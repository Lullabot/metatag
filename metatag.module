<?php
/**
 * Hook implementations for metatag module.
 */

/**
 * Implements hook_page_attachments().
 *
 * Load all meta tags for this page.
 */
function metatag_page_attachments(array &$attachments) {
  $metatags = array();
  $metatag_defaults = entity_load('metatag_defaults', 'global');

  if (!empty($metatag_defaults)) {
    // Load all tag plugins.
    $tag_manager = \Drupal::service('plugin.manager.metatag.tag');
    $tags = $tag_manager->getDefinitions();
    // Remove the title tag as it is processed at metatag_preprocess_html().
    unset($tags['title']);

    // Loop plugins and render them.
    foreach ($tags as $tag_id => $tag_definition) {
      $tag = $tag_manager->createInstance($tag_id);
      // If the config_entity has a value for this tag, set it.
      if ($metatag_defaults->hasTag($tag_id)) {
        $tag->setValue($metatag_defaults->getTag($tag_id));
        $metatags[$tag_id] = $tag->render();
      }
    }
  }

  if (!empty($metatags)) {
    foreach ($metatags as $key => $value) {
      $attachments['#attached']['html_head'][] = [$value, $key];
    }
  }
}

/**
 * Implements hook_preprocess_html().
 */
function metatag_preprocess_html(array &$variables) {
  // Alter the page title.
  $metatag_global = entity_load('metatag_defaults', 'global');
  if (!empty($metatag_global)) {
    if ($metatag_global->hasTag('title')) {
      $processed_title = \Drupal::token()->replace($metatag_global->getTag('title'));
      $variables['head_title'] = array('metatag' => $processed_title);
    }
  }
}
